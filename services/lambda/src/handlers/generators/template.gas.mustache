
/**
 * EA License Application - Google Apps Script Template (JWTç‰ˆ) - SANKEYçµ±åˆç‰ˆ
 *
 * è¨­å®šæ‰‹é †:
 * 1. ä¸‹è¨˜ã® CONFIG ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨­å®šå€¤ã‚’å…¥åŠ›
 * 2. Google Formã§onFormSubmitãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
 * 3. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«è‡ªå‹•ã§WebhookãŒå®Ÿè¡Œã•ã‚Œã¾ã™
 * 4. ç®¡ç†ç”»é¢ã‹ã‚‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¯èƒ½
 *
 * âš ï¸ Google Formé€£æºã®å ´åˆ:
 * - ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œå›ç­”ã€ã‚¿ãƒ–ã‹ã‚‰ã€Œã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒªãƒ³ã‚¯ã€ã‚’è¨­å®š
 * - ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è‡ªå‹•çš„ã«ãƒ•ã‚©ãƒ¼ãƒ é€£æºã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºã—ã¾ã™
 * - ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã¯åŒã˜ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå†…ã®åˆ¥ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¾ã™
 * - ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ã‚·ãƒ¼ãƒˆ: ã€Œãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1ã€ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
 * - ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¨˜éŒ²ã‚·ãƒ¼ãƒˆ: ã€ŒEA_LICENSESã€ï¼ˆã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½œæˆï¼‰
 * - ç”³è«‹è¨˜éŒ²ã‚·ãƒ¼ãƒˆ: ã€ŒEA_APPLICATIONSã€ï¼ˆã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½œæˆï¼‰
 */

// ============================================
// è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³(ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„)
// ============================================
var CONFIG = {

    WEBHOOK_URL: '{{{webhookUrl}}}',
    TEST_NOTIFICATION_URL: '{{{testNotificationUrl}}}',
    RESULT_NOTIFICATION_URL: '{{{resultNotificationUrl}}}',
    USER_ID: '{{{userId}}}',
    JWT_SECRET: '{{{jwtSecret}}}',

    // ãƒ•ã‚©ãƒ¼ãƒ ã®é …ç›®å(å®Ÿéš›ã®ãƒ•ã‚©ãƒ¼ãƒ é …ç›®ã«åˆã‚ã›ã¦èª¿æ•´)
    FORM_FIELDS: {
        EA_NAME: "EA",
        ACCOUNT_NUMBER: "å£åº§ç•ªå·",
        BROKER: "ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼",
        EMAIL: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
        X_ACCOUNT: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰: è¨˜éŒ²å…ˆã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
        // æœªè¨­å®šã®å ´åˆã¯æ–°è¦ä½œæˆã•ã‚Œã¾ã™
        SPREADSHEET_ID: ""
    }
};

// ============================================
// æ–°æ©Ÿèƒ½: SANKEYé€£æºæ©Ÿèƒ½ï¼ˆå†ªç­‰æ€§å¯¾å¿œç‰ˆï¼‰
// ============================================

/**
 * çµ±åˆãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ç”³è«‹é€ä¿¡
 * ğŸ”§ ä¿®æ­£: testIdã¯å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå†ªç­‰æ€§ä¿è¨¼ï¼‰
 */
function triggerIntegrationTest(testId) {
    try {
        console.log('çµ±åˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...', { testId: testId });

        if (!validateConfig()) {
            console.error('âŒ è¨­å®šãŒä¸æ­£ã§ã™');
            return {success: false, error: 'è¨­å®šãŒä¸æ­£ã§ã™'};
        }

        // ğŸ”§ ä¿®æ­£: testIdã¯å¿…é ˆï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰æä¾›ã•ã‚Œã‚‹ï¼‰
        if (!testId) {
            console.error('âŒ testIdãŒå¿…è¦ã§ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰æä¾›ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰');
            return {success: false, error: 'testId parameter is required'};
        }

        // ğŸ”§ ä¿®æ­£: å‹•çš„ç”Ÿæˆã‚’å‰Šé™¤ã€ã‚µãƒ¼ãƒãƒ¼å´testIdã®ã¿ä½¿ç”¨
        var integrationTestId = testId;

        // çµ±åˆãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã¨å®Œå…¨ä¸€è‡´ï¼‰
        var integrationTestData = {
            eaName: "Integration Test EA",
            accountNumber: "INTEGRATION_TEST_123456",
            broker: "Test Broker",
            email: "integration-test@sankey.trade",
            xAccount: "@integration_test",
            integrationTestId: integrationTestId
        };

        console.log('çµ±åˆãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§Webhooké€ä¿¡ã‚’å®Ÿè¡Œã—ã¾ã™...', {
            integrationTestId: integrationTestId
        });

        var result = sendWebhook(integrationTestData);

        if (result.success) {
            console.log('âœ… çµ±åˆãƒ†ã‚¹ãƒˆç”¨Webhooké€ä¿¡æˆåŠŸ');

            return {
                success: true,
                message: 'Integration test application submitted successfully',
                applicationId: result.response.data ? result.response.data.applicationId : 'N/A',
                testId: integrationTestId,
                nextStep: 'Integration test will be automatically approved'
            };
        } else {
            console.log('âŒ çµ±åˆãƒ†ã‚¹ãƒˆç”¨Webhooké€ä¿¡å¤±æ•—');
            return {
                success: false,
                error: 'Integration test webhook failed: ' + result.error
            };
        }

    } catch (error) {
        console.error('âŒ çµ±åˆãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
        return {success: false, error: error.toString()};
    }
}

/**
 * æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆSANKEYé€£æºãƒ†ã‚¹ãƒˆï¼‰
 */
function testConnection() {
    try {
        console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');

        // è¨­å®šå€¤æ¤œè¨¼
        if (!validateConfig()) {
            console.error('âŒ è¨­å®šãŒä¸æ­£ã§ã™');
            return {success: false, error: 'è¨­å®šãŒä¸æ­£ã§ã™'};
        }

        // JWTä½œæˆãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ç¢ºèªï¼‰
        console.log('JWTèªè¨¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™...');
        try {
            var testPayload = {
                userId: CONFIG.USER_ID,
                timestamp: new Date().toISOString(),
                testType: 'connection_test'
            };
            var testJwt = createJWT(testPayload);
            console.log('âœ… JWTä½œæˆæˆåŠŸ');
        } catch (jwtError) {
            console.error('âŒ JWTä½œæˆå¤±æ•—:', jwtError);

            // JWTä½œæˆå¤±æ•—ã‚’SANKEYã«é€šçŸ¥
            notifyTestSuccess({
                success: false,
                timestamp: new Date().toISOString(),
                details: 'JWT creation failed: ' + jwtError.toString()
            });

            return {
                success: false,
                error: 'JWT creation failed: ' + jwtError.toString()
            };
        }

        // SANKEYã«ãƒ†ã‚¹ãƒˆæˆåŠŸã‚’é€šçŸ¥
        console.log('SANKEYèªè¨¼ç¢ºèªã‚’å®Ÿè¡Œã—ã¾ã™...');

        var notificationResult = notifyTestSuccess({
            success: true,
            timestamp: new Date().toISOString(),
            details: 'GAS connection test completed - SANKEY configuration verified',
            gasProjectId: getGasProjectId()
        });

        if (notificationResult.success) {
            console.log('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆå®Œäº†');
            return {
                success: true,
                message: 'Connection test completed - SANKEY configuration verified',
                notificationResult: notificationResult.response
            };
        } else {
            console.log('âŒ SANKEYé€šçŸ¥é€ä¿¡å¤±æ•—');
            return {
                success: false,
                error: 'SANKEY notification failed: ' + notificationResult.error
            };
        }

    } catch (error) {
        console.error('âŒ ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);

        // ã‚¨ãƒ©ãƒ¼ã‚‚SANKEYã«é€šçŸ¥
        try {
            notifyTestSuccess({
                success: false,
                timestamp: new Date().toISOString(),
                details: 'GAS connection test error: ' + error.toString()
            });
        } catch (notifyError) {
            console.error('é€šçŸ¥é€ä¿¡ã‚‚ã‚¨ãƒ©ãƒ¼:', notifyError);
        }

        return {success: false, error: error.toString()};
    }
}

/**
 * SANKEYã«ãƒ†ã‚¹ãƒˆçµæœã‚’é€šçŸ¥
 */
function notifyTestSuccess(testResult) {
    try {
        if (!CONFIG.TEST_NOTIFICATION_URL || CONFIG.TEST_NOTIFICATION_URL === '') {
            console.error('TEST_NOTIFICATION_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return {success: false, error: 'TEST_NOTIFICATION_URL not configured'};
        }

        var notificationData = {
            userId: CONFIG.USER_ID,
            testResult: testResult
        };

        console.log('ãƒ†ã‚¹ãƒˆçµæœé€šçŸ¥ã‚’é€ä¿¡ä¸­...', {
            testSuccess: testResult.success,
            userId: CONFIG.USER_ID
        });

        var response = UrlFetchApp.fetch(CONFIG.TEST_NOTIFICATION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            payload: JSON.stringify(notificationData),
            muteHttpExceptions: true
        });

        var responseCode = response.getResponseCode();
        var responseText = response.getContentText();

        console.log('ãƒ†ã‚¹ãƒˆçµæœé€šçŸ¥ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
            code: responseCode,
            body: responseText
        });

        if (responseCode === 200) {
            try {
                return {
                    success: true,
                    response: JSON.parse(responseText)
                };
            } catch (parseError) {
                return {
                    success: true,
                    response: {message: responseText}
                };
            }
        } else {
            return {
                success: false,
                error: 'HTTP ' + responseCode + ': ' + responseText
            };
        }

    } catch (error) {
        console.error('ãƒ†ã‚¹ãƒˆçµæœé€šçŸ¥ã‚¨ãƒ©ãƒ¼:', error);
        return {
            success: false,
            error: error.toString()
        };
    }
}

// ============================================
// SANKEYé€šçŸ¥å—ä¿¡æ©Ÿèƒ½
// ============================================

/**
 * SANKEYã‹ã‚‰ã®é€šçŸ¥å‡¦ç†
 */
function onSankeyNotification(notificationData) {
    try {
        console.log('SANKEYé€šçŸ¥å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...');

        // å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼
        if (!notificationData.userId || !notificationData.applicationId || !notificationData.licenseId) {
            return {
                success: false,
                error: 'Missing required parameters: userId, applicationId, licenseId'
            };
        }

        var { userId, applicationId, licenseId, licenseValue, testId } = notificationData;

        console.log('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é€šçŸ¥è©³ç´°:', {
            userId: userId,
            applicationId: applicationId,
            licenseId: licenseId,
            isIntegrationTest: !!testId
        });

        // ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ç¶™ç¶šï¼‰
        try {
            recordLicenseToSpreadsheet({
                userId: userId,
                applicationId: applicationId,
                licenseId: licenseId,
                licenseValue: licenseValue,
                testId: testId,
                receivedAt: new Date()
            });
        } catch (recordError) {
            console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨˜éŒ²ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰:', recordError);
        }

        // çµ±åˆãƒ†ã‚¹ãƒˆæ™‚ã®ç‰¹åˆ¥å‡¦ç†
        if (testId) {
            console.log('çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™...', { testId: testId });

            var completionResult = notifyIntegrationTestCompletion({
                userId: userId,
                testId: testId,
                licenseId: licenseId,
                applicationId: applicationId,
                success: true,
                timestamp: new Date().toISOString(),
                details: 'Integration test completed successfully - License received via GAS webhook'
            });

            if (completionResult.success) {
                console.log('âœ… çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥é€ä¿¡æˆåŠŸ');
                return {
                    success: true,
                    message: 'License notification received and integration test completed',
                    integrationTestResult: completionResult.response
                };
            } else {
                console.log('âš ï¸ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å—ä¿¡æˆåŠŸã€ä½†ã—å®Œäº†é€šçŸ¥é€ä¿¡å¤±æ•—');
                return {
                    success: true,
                    message: 'License notification received but integration test completion failed',
                    warning: completionResult.error
                };
            }
        } else {
            // é€šå¸¸ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é€šçŸ¥
            console.log('âœ… ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é€šçŸ¥å—ä¿¡å®Œäº†');
            return {
                success: true,
                message: 'License notification received successfully'
            };
        }

    } catch (error) {
        console.error('âŒ SANKEYé€šçŸ¥å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        return {
            success: false,
            error: error.toString()
        };
    }
}

/**
 * ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
 */
function recordLicenseToSpreadsheet(licenseData) {
    try {
        var sheet = getOrCreateSheet('EA_LICENSES');

        // ã‚·ãƒ¼ãƒˆãŒå–å¾—ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!sheet) {
            console.warn('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
            return;
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ç¢ºèªãƒ»ä½œæˆ
        if (sheet.getLastRow() === 0) {
            sheet.getRange(1, 1, 1, 7).setValues([[
                'å—ä¿¡æ—¥æ™‚', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID', 'ç”³è«‹ID', 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ID', 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å€¤', 'ãƒ†ã‚¹ãƒˆID', 'å‚™è€ƒ'
            ]]);
        }

        // ãƒ‡ãƒ¼ã‚¿è¡Œã®è¿½åŠ 
        var timestamp = licenseData.receivedAt.toLocaleString('ja-JP');
        var remark = licenseData.testId ? 'çµ±åˆãƒ†ã‚¹ãƒˆ' : 'æœ¬ç•ª';

        sheet.appendRow([
            timestamp,
            licenseData.userId,
            licenseData.applicationId,
            licenseData.licenseId,
            licenseData.licenseValue || '',
            licenseData.testId || '',
            remark
        ]);

        console.log('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²å®Œäº†:', {
            sheet: sheet.getName(),
            row: sheet.getLastRow(),
            licenseId: licenseData.licenseId,
            isTest: !!licenseData.testId
        });

    } catch (error) {
        console.error('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã¯ç¶™ç¶š
    }
}

/**
 * çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ã‚’SANKEYã«é€šçŸ¥
 */
function notifyIntegrationTestCompletion(completionData) {
    try {
        var completionUrl = CONFIG.RESULT_NOTIFICATION_URL.replace('/integration/result/notification', '/integration/test/complete');

        var notificationPayload = {
            userId: completionData.userId,
            testId: completionData.testId,
            licenseId: completionData.licenseId,
            applicationId: completionData.applicationId,
            testResult: {
                success: completionData.success,
                timestamp: completionData.timestamp,
                details: completionData.details
            }
        };

        console.log('çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥ã‚’é€ä¿¡ä¸­...', {
            url: completionUrl,
            testId: completionData.testId
        });

        var response = UrlFetchApp.fetch(completionUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            payload: JSON.stringify(notificationPayload),
            muteHttpExceptions: true
        });

        var responseCode = response.getResponseCode();
        var responseText = response.getContentText();

        console.log('çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
            code: responseCode,
            body: responseText
        });

        if (responseCode === 200) {
            try {
                return {
                    success: true,
                    response: JSON.parse(responseText)
                };
            } catch (parseError) {
                return {
                    success: true,
                    response: { message: responseText }
                };
            }
        } else {
            return {
                success: false,
                error: 'HTTP ' + responseCode + ': ' + responseText
            };
        }

    } catch (error) {
        console.error('çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥ã‚¨ãƒ©ãƒ¼:', error);
        return {
            success: false,
            error: error.toString()
        };
    }
}

// ============================================
// å…±é€šæ©Ÿèƒ½
// ============================================

/**
 * ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†ï¼ˆãƒˆãƒªã‚¬ãƒ¼ç”¨ï¼‰
 */
function onFormSubmit(e) {
    try {
        console.log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ');

        // ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const formData = {
            eaName: e.namedValues[CONFIG.FORM_FIELDS.EA_NAME]?.[0] || '',
            accountNumber: e.namedValues[CONFIG.FORM_FIELDS.ACCOUNT_NUMBER]?.[0] || '',
            broker: e.namedValues[CONFIG.FORM_FIELDS.BROKER]?.[0] || '',
            email: e.namedValues[CONFIG.FORM_FIELDS.EMAIL]?.[0] || '',
            xAccount: e.namedValues[CONFIG.FORM_FIELDS.X_ACCOUNT]?.[0] || ''
        };

        console.log('ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:', formData);

        // Webhookã‚’é€ä¿¡
        const result = sendWebhook(formData);

        // çµæœã‚’è¨˜éŒ²
        recordToSpreadsheet(formData, result.response);

        if (result.success) {
            console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†æˆåŠŸ');
        } else {
            console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†å¤±æ•—:', result.error);
        }

    } catch (error) {
        console.error('âŒ onFormSubmitã‚¨ãƒ©ãƒ¼:', error);
    }
}

/**
 * Webhookã®é€ä¿¡(JWTç‰ˆ)
 */
function sendWebhook(formData) {
    try {
        var jwt = createJWT(formData);

        console.log('JWTç½²åæ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†', {
            jwtLength: jwt.length,
            userId: CONFIG.USER_ID
        });

        var response = UrlFetchApp.fetch(CONFIG.WEBHOOK_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            payload: JSON.stringify({
                userId: CONFIG.USER_ID,
                data: jwt,
                iv: "",
                hmac: "jwt-signed",
                method: "JWT"
            }),
            muteHttpExceptions: true
        });

        var responseCode = response.getResponseCode();
        var responseText = response.getContentText();

        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
            code: responseCode,
            body: responseText
        });

        if (responseCode === 200) {
            try {
                return {
                    success: true,
                    response: JSON.parse(responseText)
                };
            } catch (parseError) {
                return {
                    success: true,
                    response: {message: responseText}
                };
            }
        } else if (responseCode === 503) {
            console.log('ã‚µãƒ¼ãƒ“ã‚¹ä¸€æ™‚åˆ©ç”¨ä¸å¯ - 3ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™');
            Utilities.sleep(3000);
            return sendWebhook(formData);
        } else {
            return {
                success: false,
                error: 'HTTP ' + responseCode + ': ' + responseText
            };
        }

    } catch (error) {
        console.error('sendWebhook ã‚¨ãƒ©ãƒ¼:', error);
        return {
            success: false,
            error: error.toString()
        };
    }
}

/**
 * JWTã®ä½œæˆï¼ˆJWT_SECRETã‚’ä½¿ç”¨ï¼‰
 */
function createJWT(payload) {
    try {
        var header = {
            alg: "HS256",
            typ: "JWT"
        };

        var jwtPayload = {
            data: payload,
            iat: Math.floor(Date.now() / 1000),
            exp: Math.floor(Date.now() / 1000) + 300,
            userId: CONFIG.USER_ID
        };

        var headerEncoded = base64UrlEncode(JSON.stringify(header));
        var payloadEncoded = base64UrlEncode(JSON.stringify(jwtPayload));
        var signatureInput = headerEncoded + "." + payloadEncoded;

        var keyBytes = Utilities.base64Decode(CONFIG.JWT_SECRET);
        var signatureInputBytes = Utilities.newBlob(signatureInput).getBytes();
        var signatureBytes = Utilities.computeHmacSha256Signature(signatureInputBytes, keyBytes);
        var signature = base64UrlEncode(signatureBytes);

        return signatureInput + "." + signature;

    } catch (error) {
        console.error('JWTä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        throw new Error('JWTä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
    }
}

/**
 * Base64URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰(JWTç”¨)
 */
function base64UrlEncode(data) {
    var base64 = Utilities.base64Encode(data);
    return base64
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
}

/**
 * GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDå–å¾—
 */
function getGasProjectId() {
    try {
        return ScriptApp.getScriptId();
    } catch (error) {
        console.error('GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return '';
    }
}

/**
 * è¨­å®šå€¤ã®æ¤œè¨¼
 */
function validateConfig() {
    var issues = [];

    if (!CONFIG.WEBHOOK_URL || CONFIG.WEBHOOK_URL.indexOf('your-api') !== -1) {
        issues.push('WEBHOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    if (!CONFIG.USER_ID || CONFIG.USER_ID.indexOf('xxxx') !== -1) {
        issues.push('USER_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    if (!CONFIG.JWT_SECRET || CONFIG.JWT_SECRET.indexOf('your-') !== -1) {
        issues.push('JWT_SECRET ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    if (issues.length > 0) {
        console.error('âŒ è¨­å®šã‚¨ãƒ©ãƒ¼:', issues);
        return false;
    }

    console.log('âœ… è¨­å®šã¯æ­£å¸¸ã§ã™');
    return true;
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
 */
function recordToSpreadsheet(formData, responseData) {
    try {
        var sheet = getOrCreateSheet('EA_APPLICATIONS');

        // ã‚·ãƒ¼ãƒˆãŒå–å¾—ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!sheet) {
            console.warn('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
            return;
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ç¢ºèªãƒ»ä½œæˆ
        if (sheet.getLastRow() === 0) {
            sheet.getRange(1, 1, 1, 8).setValues([[
                'ç”³è«‹æ—¥æ™‚', 'EAå', 'ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼', 'å£åº§ç•ªå·', 'ãƒ¡ãƒ¼ãƒ«', 'Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆ', 'ç”³è«‹ID', 'ä¸€æ™‚URL'
            ]]);
        }

        // ãƒ‡ãƒ¼ã‚¿è¡Œã®è¿½åŠ 
        var timestamp = new Date().toLocaleString('ja-JP');
        var applicationId = '';
        var temporaryUrl = '';

        if (responseData && responseData.data) {
            applicationId = responseData.data.applicationId || '';
            temporaryUrl = responseData.data.temporaryUrl || '';
        }

        sheet.appendRow([
            timestamp,
            formData.eaName,
            formData.broker,
            formData.accountNumber,
            formData.email,
            formData.xAccount,
            applicationId,
            temporaryUrl
        ]);

        console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²å®Œäº†:', {
            sheet: sheet.getName(),
            row: sheet.getLastRow(),
            applicationId: applicationId
        });

    } catch (error) {
        console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã¯ç¶™ç¶š
    }
}

/**
 * ã‚·ãƒ¼ãƒˆå–å¾—ã¾ãŸã¯ä½œæˆï¼ˆGoogle Formé€£æºç‰ˆï¼‰
 */
function getOrCreateSheet(sheetName) {
    try {
        let spreadsheet = null;

        // æ–¹æ³•1: Formã«ç´ã¥ã„ãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ï¼ˆæ¨å¥¨ï¼‰
        try {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚©ãƒ¼ãƒ ã‚’å–å¾—
            const form = FormApp.getActiveForm();
            if (form) {
                // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å…ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å–å¾—
                const destinationId = form.getDestinationId();
                if (destinationId) {
                    spreadsheet = SpreadsheetApp.openById(destinationId);
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ ã«ç´ã¥ã„ãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨:', destinationId);
                } else {
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒç´ã¥ã„ã¦ã„ã¾ã›ã‚“');
                }
            }
        } catch (formError) {
            console.log('ãƒ•ã‚©ãƒ¼ãƒ é€£æºã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', formError);
        }

        // æ–¹æ³•2: æ‰‹å‹•ã§è¨­å®šã•ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’ä½¿ç”¨
        if (!spreadsheet && CONFIG.FORM_FIELDS.SPREADSHEET_ID && CONFIG.FORM_FIELDS.SPREADSHEET_ID.trim() !== '') {
            try {
                spreadsheet = SpreadsheetApp.openById(CONFIG.FORM_FIELDS.SPREADSHEET_ID.trim());
                console.log('è¨­å®šã•ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’ä½¿ç”¨:', CONFIG.FORM_FIELDS.SPREADSHEET_ID);
            } catch (openError) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒç„¡åŠ¹ã§ã™:', openError);
            }
        }

        // æ–¹æ³•3: ç¾åœ¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰å®Ÿè¡Œæ™‚ï¼‰
        if (!spreadsheet) {
            try {
                spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
                if (spreadsheet) {
                    console.log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨');
                }
            } catch (activeError) {
                console.log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', activeError);
            }
        }

        // æ–¹æ³•4: æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
        if (!spreadsheet) {
            try {
                console.log('æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™...');
                spreadsheet = SpreadsheetApp.create('EA License Integration Test Data - ' + new Date().toISOString());

                console.log('âœ… æ–°è¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆæˆåŠŸ:', {
                    spreadsheetId: spreadsheet.getId(),
                    url: spreadsheet.getUrl(),
                    message: 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ã®é€ä¿¡å…ˆã‚’ã“ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™'
                });
            } catch (createError) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', createError);
                return null;
            }
        }

        // ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
        if (spreadsheet) {
            let sheet = null;

            // æ—¢å­˜ã®ã‚·ãƒ¼ãƒˆã‚’æ¢ã™
            try {
                sheet = spreadsheet.getSheetByName(sheetName);
                if (sheet) {
                    console.log('æ—¢å­˜ã®ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨:', sheetName);
                }
            } catch (e) {
                console.log('ã‚·ãƒ¼ãƒˆæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', e);
            }

            // ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½œæˆ
            if (!sheet) {
                try {
                    sheet = spreadsheet.insertSheet(sheetName);
                    console.log('æ–°ã—ã„ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ:', sheetName);
                } catch (insertError) {
                    console.error('ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', insertError);

                    // ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ã‚·ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã¨ã¯åˆ¥ã®ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
                    try {
                        const sheets = spreadsheet.getSheets();
                        if (sheets && sheets.length > 0) {
                            // æœ€å¾Œã®ã‚·ãƒ¼ãƒˆã®å¾Œã«æ–°è¦ã‚·ãƒ¼ãƒˆè¿½åŠ 
                            const lastIndex = sheets.length;
                            sheet = spreadsheet.insertSheet(sheetName, lastIndex);
                            console.log('ã‚·ãƒ¼ãƒˆã‚’æœ€å¾Œã«è¿½åŠ ã—ã¾ã—ãŸ:', sheetName);
                        }
                    } catch (fallbackError) {
                        console.error('ã‚·ãƒ¼ãƒˆè¿½åŠ ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—:', fallbackError);
                        return null;
                    }
                }
            }

            return sheet;
        }

        return null;

    } catch (error) {
        console.error('getOrCreateSheetå®Œå…¨ã‚¨ãƒ©ãƒ¼:', error);
        return null;
    }
}

/**
 * Webã‚¢ãƒ—ãƒªã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
 * - SANKEYã‹ã‚‰ã®é€šçŸ¥å—ä¿¡
 * - çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆtestIdå¿…é ˆï¼‰
 */
function doPost(e) {
    try {
        console.log('POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã¾ã—ãŸ');

        if (!e.postData || !e.postData.contents) {
            return ContentService.createTextOutput(JSON.stringify({
                success: false,
                error: 'No POST data received'
            })).setMimeType(ContentService.MimeType.JSON);
        }

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
        var requestData = JSON.parse(e.postData.contents);
        console.log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', requestData);

        // ğŸ”§ ä¿®æ­£: çµ±åˆãƒ†ã‚¹ãƒˆå‡¦ç†ï¼ˆtestIdå¿…é ˆæ¤œè¨¼ï¼‰
        if (requestData.action === 'integration_test') {
            console.log('çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡:', {
                testId: requestData.testId,
                timestamp: requestData.timestamp
            });

            // ğŸ”§ testIdã®å¿…é ˆæ¤œè¨¼ã‚’è¿½åŠ 
            if (!requestData.testId) {
                return ContentService.createTextOutput(JSON.stringify({
                    success: false,
                    error: 'testId is required for integration test'
                })).setMimeType(ContentService.MimeType.JSON);
            }

            // çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚µãƒ¼ãƒãƒ¼å´testIdã‚’å³å¯†ã«ä½¿ç”¨ï¼‰
            var result = triggerIntegrationTest(requestData.testId);

            return ContentService.createTextOutput(JSON.stringify(result))
                .setMimeType(ContentService.MimeType.JSON);
        }

        // æ—¢å­˜: SANKEYã‹ã‚‰ã®é€šçŸ¥å‡¦ç†
        console.log('SANKEYã‹ã‚‰ã®é€šçŸ¥ã¨ã—ã¦å‡¦ç†ã—ã¾ã™');
        var result = onSankeyNotification(requestData);
        
        return ContentService.createTextOutput(JSON.stringify(result))
            .setMimeType(ContentService.MimeType.JSON);
            
    } catch (error) {
        console.error('doPostå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        return ContentService.createTextOutput(JSON.stringify({
            success: false,
            error: error.toString()
        })).setMimeType(ContentService.MimeType.JSON);
    }
}