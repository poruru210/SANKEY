# ğŸ”„ Sankey Environment Setup TDDãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¼•ç¶™ãè³‡æ–™
**æ›´æ–°æ—¥**: 2024å¹´12æœˆ  
**å‰å›ä½œæ¥­è€…**: Claude Assistant  
**ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º**: Jestã‹ã‚‰Vitestã¸ã®ç§»è¡Œå®Œäº†ã€ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–å®Œäº†

## ğŸ“Š ç¾åœ¨ã®çŠ¶æ³

### å®Œäº†ã—ãŸä½œæ¥­
1. **Vitestç§»è¡Œå®Œäº†** âœ…
   - Jest 30.0.0 â†’ Vitest 3.2.3
   - å…¨ãƒ†ã‚¹ãƒˆï¼ˆ81å€‹ï¼‰ãŒæ­£å¸¸ã«å‹•ä½œ
   - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚‚å‹•ä½œç¢ºèªæ¸ˆã¿

2. **ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–å®Œäº†** âœ…
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç§»è¡Œ
   - `package.json`ã«`"type": "module"`è¿½åŠ 
   - å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§`import`/`export`æ§‹æ–‡ä½¿ç”¨

3. **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆçŠ¶æ³** 
```
dev-tools/
â”œâ”€â”€ vitest.config.js            âœ… ä½œæˆæ¸ˆã¿ï¼ˆESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾å¿œï¼‰
â”œâ”€â”€ package.json                âœ… ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šæ¸ˆã¿
â””â”€â”€ __tests__/
    â”œâ”€â”€ test-helpers.js         âœ… ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–æ¸ˆã¿
    â”œâ”€â”€ core/
    â”‚   â”œâ”€â”€ utils.test.js       âœ… 26ãƒ†ã‚¹ãƒˆï¼ˆESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–æ¸ˆã¿ï¼‰
    â”‚   â””â”€â”€ errors.test.js      âœ… 16ãƒ†ã‚¹ãƒˆï¼ˆESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–æ¸ˆã¿ï¼‰
    â””â”€â”€ services/
        â””â”€â”€ vercel.test.js      âœ… 39ãƒ†ã‚¹ãƒˆï¼ˆESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–æ¸ˆã¿ï¼‰
```

4. **å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§**
```
ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–æ¸ˆã¿ï¼‰:
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ constants.js    âœ… exportæ§‹æ–‡ã«å¤‰æ›
â”‚   â”œâ”€â”€ errors.js       âœ… export classæ§‹æ–‡ã«å¤‰æ›
â”‚   â””â”€â”€ utils.js        âœ… import/exportæ§‹æ–‡ã«å¤‰æ›
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ aws.js          âœ… import/exportæ§‹æ–‡ã«å¤‰æ›
â”‚   â”œâ”€â”€ cloudflare.js   âœ… import/exportæ§‹æ–‡ã«å¤‰æ›
â”‚   â””â”€â”€ vercel.js       âœ… import/exportæ§‹æ–‡ã«å¤‰æ›
â””â”€â”€ setup-environment.js âœ… importæ§‹æ–‡ã«å¤‰æ›ã€__dirnameå¯¾å¿œæ¸ˆã¿
```

5. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®çŠ¶æ³**
```
â€» Vitestã§ã¯`pnpm test:coverage`ã§ç¢ºèªå¯èƒ½
ç¾åœ¨ã®ã‚«ãƒãƒ¬ãƒƒã‚¸çŠ¶æ³ã¯ç§»è¡Œå‰ã¨åŒç­‰
```

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### 1. **cloudflare.test.js ã®ä½œæˆ**ï¼ˆæ¨å¥¨ï¼‰
ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å½¢å¼ã§ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### 2. **å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ»æƒ…å ±**
æ¬¡å›ã®æ‹…å½“è€…ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

```markdown
## æ¬¡å›ä½œæ¥­é–‹å§‹æ™‚ã®æº–å‚™ï¼š

1. **ãƒ†ã‚¹ãƒˆä½œæˆã®åŸºæœ¬æ§‹é€ ï¼ˆESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆï¼‰**
   ```javascript
   import { describe, test, expect, beforeEach, vi } from 'vitest';
   import { createFetchResponse, createFetchError } from '../test-helpers.js';
   
   // ãƒ¢ãƒƒã‚¯ã®è¨­å®š
   vi.mock('https', () => ({
     request: vi.fn()
   }));
   ```

2. **Cloudflare APIã®ç‰¹å¾´**
   - httpsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ï¼ˆfetchã§ã¯ãªã„ï¼‰
   - èªè¨¼ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã§å®Ÿæ–½
   - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒ å½¢å¼

3. **ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ä¸»è¦æ©Ÿèƒ½**
   - prepareWildcardCertificate
   - setupDnsForCustomDomain
   - CloudflareClientåŸºåº•ã‚¯ãƒ©ã‚¹
```

## ğŸ“ ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç§»è¡Œã§ã®ä¸»ãªå¤‰æ›´ç‚¹

### import/exportæ§‹æ–‡
```javascript
// å¤‰æ›´å‰ï¼ˆCommonJSï¼‰
const { something } = require('./module');
module.exports = { myFunction };

// å¤‰æ›´å¾Œï¼ˆESMï¼‰
import { something } from './module.js';
export { myFunction };
```

### ãƒ¢ãƒƒã‚¯ã®æ³¨æ„ç‚¹
```javascript
// vi.mockã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«ãƒ›ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚
vi.mock('crypto', () => {
    const { createCryptoMock } = require('../test-helpers.js');
    const mock = createCryptoMock();
    return {
        default: mock,
        ...mock
    };
});
```

## ğŸš€ ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§
```bash
# cloudflare.test.jsä½œæˆ
New-Item -Path "__tests__\services\cloudflare.test.js" -ItemType File -Force

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pnpm test

# ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆ
pnpm test __tests__/services/cloudflare.test.js

# ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
pnpm test:coverage

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
pnpm test:watch

# UIãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªï¼‰
pnpm test:ui
```

## âš ï¸ æ³¨æ„äº‹é …
1. **ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ‹¡å¼µå­**: importãƒ‘ã‚¹ã«ã¯å¿…ãš`.js`ã‚’ä»˜ã‘ã‚‹
2. **ãƒ¢ãƒƒã‚¯ã®ã‚¯ãƒªã‚¢**: å„ãƒ†ã‚¹ãƒˆå¾Œã«`vi.clearAllMocks()`
3. **httpsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ¢ãƒƒã‚¯**: Cloudflareã¯httpsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨
4. **console.logæŠ‘åˆ¶**: vercel.test.jsã¨åŒæ§˜ã«`beforeAll`ã§è¨­å®š

## ğŸ“ˆ ç›®æ¨™
- cloudflare.js: ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š
- å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸: 30%ä»¥ä¸Š

## ğŸ”— å‚è€ƒè³‡æ–™
- [Vitest Documentation](https://vitest.dev/)
- [Cloudflare API v4 Documentation](https://developers.cloudflare.com/api/)
- ä½œæˆæ¸ˆã¿ã®vercel.test.jsï¼ˆESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆï¼‰

## ğŸ’¡ ç§»è¡Œå®Œäº†ã®ãƒ¡ãƒªãƒƒãƒˆ
1. **Vitest**: ã‚ˆã‚Šé«˜é€Ÿãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
2. **ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: å°†æ¥çš„ãªæ¨™æº–ã¸ã®æº–æ‹ 
3. **çµ±ä¸€ã•ã‚ŒãŸæ§‹æ–‡**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ä¸€è²«æ€§ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰

---
**ä½œæˆæ—¥**: 2024å¹´12æœˆ  
**æ¬¡ã®æ‹…å½“è€…ã¸ã®ç”³ã—é€ã‚Š**:
- Vitestç§»è¡Œã¨ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã¯å®Œäº†æ¸ˆã¿ã§ã™
- cloudflare.test.jsã‚’ä½œæˆã™ã‚‹éš›ã¯ã€å¿…ãšESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„
- httpsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ¢ãƒƒã‚¯æ–¹æ³•ã«æ³¨æ„ãŒå¿…è¦ã§ã™ï¼ˆvercel.jsã¨ã¯ç•°ãªã‚‹ï¼‰
- ãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¯å…¨ã¦exportåŒ–ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€importã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„